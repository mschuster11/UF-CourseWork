//  File:   Timer1_Utils.c
//  Date:   02/24/2018
//  Name:   Mark Schuster
//  Class:  EEE4511C (DSP)

#include "msLib.h"

/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 48000 Hz

* 0 Hz - 1490 Hz
  gain = 1
  desired ripple = 3 dB
  actual ripple = 2.0057410958006363 dB

* 3100 Hz - 24000 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -41.42777662856003 dB

*/

float lpfFirWeights[FILTER_TAP_NUM_FIR_LPF] = {
  -0.006458890599120238,
  -0.0052277234367167115,
  -0.006802500304306202,
  -0.008193107806323893,
  -0.009163750472661164,
  -0.00945852694971267,
  -0.008816196248689984,
  -0.007009096032907269,
  -0.00383359020603197,
  0.0008093761425741296,
  0.0069640516710003895,
  0.01454950392877843,
  0.02337091925327902,
  0.033140681462845246,
  0.043467422746496225,
  0.053886032275704335,
  0.06388431627817463,
  0.0729551021795933,
  0.08060480653931533,
  0.08640199887081489,
  0.09001978297922335,
  0.09124846729592041,
  0.09001978297922335,
  0.08640199887081489,
  0.08060480653931533,
  0.0729551021795933,
  0.06388431627817463,
  0.053886032275704335,
  0.043467422746496225,
  0.033140681462845246,
  0.02337091925327902,
  0.01454950392877843,
  0.0069640516710003895,
  0.0008093761425741296,
  -0.00383359020603197,
  -0.007009096032907269,
  -0.008816196248689984,
  -0.00945852694971267,
  -0.009163750472661164,
  -0.008193107806323893,
  -0.006802500304306202,
  -0.0052277234367167115,
  -0.006458890599120238
};


/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 48000 Hz

* 0 Hz - 700 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -40.16027932496705 dB

* 1000 Hz - 1800 Hz
  gain = 1
  desired ripple = 3 dB
  actual ripple = 2.3243783057628526 dB

* 2400 Hz - 24000 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -40.16027932496705 dB

*/

float bpfFirWeights[FILTER_TAP_NUM_FIR_BPF] = {
  -0.005550607155108627,
  -0.0013056523576555079,
  -0.0013342155644092896,
  -0.001269101310882767,
  -0.001101421082460746,
  -0.0008273684084292744,
  -0.0004491957439684645,
  0.000024603430435381685,
  0.0005792828460565788,
  0.001194656709923292,
  0.001845498464130876,
  0.0025025189675394266,
  0.0031343997760353358,
  0.003708870767678973,
  0.004195412370955356,
  0.004565599392029179,
  0.004795983474838851,
  0.004867516274284377,
  0.004769615960081084,
  0.004497442595380547,
  0.004054523482725583,
  0.0034513935424908735,
  0.002705389176418765,
  0.001840601972125689,
  0.0008856080403549967,
  -0.0001279910715565196,
  -0.0011655273606744083,
  -0.0021915786055739478,
  -0.003172637659481723,
  -0.004075027784659611,
  -0.004870725656342098,
  -0.005533516807498927,
  -0.00604329211033132,
  -0.006384750558594912,
  -0.006548896807853559,
  -0.006532152252981715,
  -0.006337043433827243,
  -0.005971711665147881,
  -0.005449896415970832,
  -0.004790529990802946,
  -0.004016818114311403,
  -0.003156062425311335,
  -0.0022387554259162517,
  -0.001299008433040772,
  -0.0003650969957501046,
  0.000512687705217782,
  0.0013286874506353132,
  0.002031959164414224,
  0.002601597098910619,
  0.003025455138443938,
  0.0032935671517588163,
  0.0034022432252419003,
  0.003358794628523227,
  0.0031826920719666245,
  0.0029045727065859475,
  0.0025637172799632046,
  0.002205591276143405,
  0.0018806660955073108,
  0.0016409612114559905,
  0.0015379155922844096,
  0.001617013336456975,
  0.0019149591319081018,
  0.00245403020260472,
  0.003240645625434443,
  0.004260320967111584,
  0.005477027216898309,
  0.006832751731288787,
  0.008249063756204659,
  0.009630419549910002,
  0.010867124966547324,
  0.01184062865328758,
  0.012432442858158097,
  0.012531030341076367,
  0.01203602370121854,
  0.010873898244569915,
  0.008996957757385482,
  0.00639647016306678,
  0.003103148704083669,
  -0.0008086209505012681,
  -0.0052216644355174745,
  -0.009978009769410935,
  -0.014884827406725944,
  -0.01972220950652443,
  -0.024253356612257155,
  -0.028236448919145174,
  -0.031437139509148455,
  -0.03364243456035483,
  -0.0346731859284739,
  -0.034397609583139456,
  -0.032735985094257215,
  -0.029679341889910622,
  -0.025275350498777993,
  -0.01964904819252152,
  -0.012986430480041965,
  -0.005528939977722972,
  0.0024329162069420527,
  0.010573660763370355,
  0.018550192463854295,
  0.026018333704934817,
  0.03264960794675452,
  0.03814772569637046,
  0.04226378302615264,
  0.044811024405979415,
  0.045673080421838506,
  0.044811024405979415,
  0.04226378302615264,
  0.03814772569637046,
  0.03264960794675452,
  0.026018333704934817,
  0.018550192463854295,
  0.010573660763370355,
  0.0024329162069420527,
  -0.005528939977722972,
  -0.012986430480041965,
  -0.01964904819252152,
  -0.025275350498777993,
  -0.029679341889910622,
  -0.032735985094257215,
  -0.034397609583139456,
  -0.0346731859284739,
  -0.03364243456035483,
  -0.031437139509148455,
  -0.028236448919145174,
  -0.024253356612257155,
  -0.01972220950652443,
  -0.014884827406725944,
  -0.009978009769410935,
  -0.0052216644355174745,
  -0.0008086209505012681,
  0.003103148704083669,
  0.00639647016306678,
  0.008996957757385482,
  0.010873898244569915,
  0.01203602370121854,
  0.012531030341076367,
  0.012432442858158097,
  0.01184062865328758,
  0.010867124966547324,
  0.009630419549910002,
  0.008249063756204659,
  0.006832751731288787,
  0.005477027216898309,
  0.004260320967111584,
  0.003240645625434443,
  0.00245403020260472,
  0.0019149591319081018,
  0.001617013336456975,
  0.0015379155922844096,
  0.0016409612114559905,
  0.0018806660955073108,
  0.002205591276143405,
  0.0025637172799632046,
  0.0029045727065859475,
  0.0031826920719666245,
  0.003358794628523227,
  0.0034022432252419003,
  0.0032935671517588163,
  0.003025455138443938,
  0.002601597098910619,
  0.002031959164414224,
  0.0013286874506353132,
  0.000512687705217782,
  -0.0003650969957501046,
  -0.001299008433040772,
  -0.0022387554259162517,
  -0.003156062425311335,
  -0.004016818114311403,
  -0.004790529990802946,
  -0.005449896415970832,
  -0.005971711665147881,
  -0.006337043433827243,
  -0.006532152252981715,
  -0.006548896807853559,
  -0.006384750558594912,
  -0.00604329211033132,
  -0.005533516807498927,
  -0.004870725656342098,
  -0.004075027784659611,
  -0.003172637659481723,
  -0.0021915786055739478,
  -0.0011655273606744083,
  -0.0001279910715565196,
  0.0008856080403549967,
  0.001840601972125689,
  0.002705389176418765,
  0.0034513935424908735,
  0.004054523482725583,
  0.004497442595380547,
  0.004769615960081084,
  0.004867516274284377,
  0.004795983474838851,
  0.004565599392029179,
  0.004195412370955356,
  0.003708870767678973,
  0.0031343997760353358,
  0.0025025189675394266,
  0.001845498464130876,
  0.001194656709923292,
  0.0005792828460565788,
  0.000024603430435381685,
  -0.0004491957439684645,
  -0.0008273684084292744,
  -0.001101421082460746,
  -0.001269101310882767,
  -0.0013342155644092896,
  -0.0013056523576555079,
  -0.005550607155108627
};


/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 48000 Hz

* 0 Hz - 2000 Hz
  gain = 0
  desired attenuation = -30 dB
  actual attenuation = -35.883659487624854 dB

* 4000 Hz - 24000 Hz
  gain = 1
  desired ripple = 3 dB
  actual ripple = 1.1974127997293782 dB

*/

float hpfFirWeights[FILTER_TAP_NUM_FIR_HPF] = {
  -0.031838401643728594,
  0.0064122218895261655,
  0.00976495299703675,
  0.01440699048722218,
  0.018932398840236647,
  0.02174798406862183,
  0.021296223390531832,
  0.01630845892105471,
  0.006051323386266427,
  -0.009482725050514238,
  -0.029506993109006438,
  -0.05247080828847111,
  -0.07611474810950448,
  -0.09810777362216545,
  -0.1159565445779877,
  -0.12759377120503504,
  0.8683650669381691,
  -0.12759377120503504,
  -0.1159565445779877,
  -0.09810777362216545,
  -0.07611474810950448,
  -0.05247080828847111,
  -0.029506993109006438,
  -0.009482725050514238,
  0.006051323386266427,
  0.01630845892105471,
  0.021296223390531832,
  0.02174798406862183,
  0.018932398840236647,
  0.01440699048722218,
  0.00976495299703675,
  0.0064122218895261655,
  -0.031838401643728594
};


float lpfIirWeights[FILTER_IIR_LPF_NUM_CASCADED_STAGES][FILTER_IIR_SOS_COLUMNS] = {
     {0.0071821,0.014364,0.0071821,1,-1.6707,0.69944},
     {0.0069888,0.013978,0.0069888,1,-1.8772,0.90951},
     {0.0086412,0.017282,0.0086412,1,-1.7408,0.77075}
};

float bpfIirWeights[FILTER_IIR_BPF_NUM_CASCADED_STAGES][FILTER_IIR_SOS_COLUMNS] = {
     {0.024856,0,-0.024856,1,-1.941,0.95029},
     {0.031546,0,-0.031546,1,-1.9345,0.94112},
     {0.019932,0,-0.019932,1,-1.9878,0.99047},
     {0.022655,0,-0.022655,1,-1.9692,0.98039},
     {0.037778,0,-0.037778,1,-1.968,0.97112},
     {0.035133,0,-0.035133,1,-1.9478,0.95213},
};

void initWeights(float* weights, Uint16 len, float scaler)
{
    for(Uint16 i=0;i<len;i++)
        weights[i] = scaler*weights[i];

}

float firC(float* weights, float* samples, Uint16 weightLen)
{
    float res = 0;
    for(int i=0;i<weightLen;i++)
        res+=weights[i]*samples[-i];

	return res;
}



float iirLpf(Uint16 numCascades, Uint16 numColumns, float weights[][numColumns], float* samples)
{
    float res = 0;
    static float y0[3] = {0,0,0};
    static float y1[3] = {0,0,0};
    static float y2[3] = {0,0,0};



    y0[2] = (weights[0][0]*samples[0] + weights[0][1]*samples[-1] + weights[0][2]*samples[-2]
          - weights[0][4]*y0[1] - weights[0][5]*y0[0]);

    y1[2] = (weights[1][0]*y0[2] + weights[1][1]*y0[1] + weights[1][2]*y0[0]
          - weights[1][4]*y1[1] - weights[1][5]*y1[0]);

    y2[2] = (weights[2][0]*y1[2] + weights[2][1]*y1[1] + weights[2][2]*y1[0]
          - weights[2][4]*y2[1] - weights[2][5]*y2[0]);

    res = y2[2];

    y0[0] = y0[1];
    y0[1] = y0[2];

    y1[0] = y1[1];
    y1[1] = y1[2];

    y2[0] = y2[1];
    y2[1] = y2[2];

    return res*(1<<15);
}

float iirBpf(Uint16 numCascades, Uint16 numColumns, float weights[][numColumns], float* samples)
{
    float res = 0;
    static float y0[3] = {0,0,0};
    static float y1[3] = {0,0,0};
    static float y2[3] = {0,0,0};    
    static float y3[3] = {0,0,0};
    static float y4[3] = {0,0,0};
    static float y5[3] = {0,0,0};

    y0[2] = (weights[0][0]*samples[0] + weights[0][1]*samples[-1] + weights[0][2]*samples[-2]
          - weights[0][4]*y0[1] - weights[0][5]*y0[0]);

    y1[2] = (weights[1][0]*y0[2] + weights[1][1]*y0[1] + weights[1][2]*y0[0]
          - weights[1][4]*y1[1] - weights[1][5]*y1[0]);

    y2[2] = (weights[2][0]*y1[2] + weights[2][1]*y1[1] + weights[2][2]*y1[0]
          - weights[2][4]*y2[1] - weights[2][5]*y2[0]);

    y3[2] = (weights[2][0]*y2[2] + weights[2][1]*y2[1] + weights[2][2]*y2[0]
          - weights[2][4]*y3[1] - weights[2][5]*y3[0]);

    y4[2] = (weights[2][0]*y3[2] + weights[2][1]*y3[1] + weights[2][2]*y3[0]
          - weights[2][4]*y4[1] - weights[2][5]*y4[0]);

    y5[2] = (weights[2][0]*y4[2] + weights[2][1]*y4[1] + weights[2][2]*y4[0]
          - weights[2][4]*y5[1] - weights[2][5]*y5[0]);

    res = y5[2];

    y0[0] = y0[1];
    y0[1] = y0[2];

    y1[0] = y1[1];
    y1[1] = y1[2];

    y2[0] = y2[1];
    y2[1] = y2[2];

    y3[0] = y3[1];
    y3[1] = y3[2];

    y4[0] = y4[1];
    y4[1] = y4[2];

    y5[0] = y5[1];
    y5[1] = y5[2];

    return res*(1<<15);
}
